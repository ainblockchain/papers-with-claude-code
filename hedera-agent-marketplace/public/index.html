<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Generation Marketplace — Requester Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* Background — neutral dark */
  --black: #0f1117;
  --charcoal: #131620;
  --indigo: #161922;
  --deep-purple: #1a1d2e;
  --violet: #1e2235;
  --ultraviolet: #6366f1;
  --light-purple: #818cf8;
  --cobalt: #3b82f6;
  --light-blue: #60a5fa;
  --white: #ffffff;
  --success: #22c55e;
  --error: #ef4444;
  --warning: #f59e0b;
  --gold: #fbbf24;
  --green: #22c55e;
  /* Card surfaces */
  --bg-card: rgba(28, 32, 48, 0.6);
  --bg-card-hover: rgba(28, 32, 48, 0.8);
  --bg-glass: rgba(22, 25, 34, 0.7);
  --border-card: rgba(255, 255, 255, 0.08);
  --border-card-hover: rgba(255, 255, 255, 0.15);
  --border-subtle: rgba(255, 255, 255, 0.06);
  /* Text — improved contrast */
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --font-body: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
  --radius-sm: 8px; --radius-md: 10px; --radius-lg: 14px; --radius-pill: 36px;
  --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.12);
  /* Event/message type colors */
  --color-request: #3b82f6;
  --color-bid: #8b5cf6;
  --color-accepted: #f59e0b;
  --color-work: #10b981;
  --color-review: #ec4899;
  --color-money: #f59e0b;
  --color-complete: #22c55e;
}

html { font-size: 15px; }
body { font-family: var(--font-body); color: var(--text-primary); min-height: 100vh; overflow: hidden;
  background: var(--black); }
a { color: var(--light-purple); text-decoration: none; transition: color 0.2s; }
a:hover { color: var(--ultraviolet); text-decoration: underline; }

#app { display: flex; flex-direction: column; height: 100vh; }

/* Header */
header { display: flex; align-items: center; justify-content: space-between; padding: 0 28px; height: 64px;
  border-bottom: 1px solid var(--border-subtle); background: var(--charcoal);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); flex-shrink: 0; z-index: 10; }
.header-left { display: flex; align-items: center; gap: 16px; }
.logo-mark { width: 36px; height: 36px; background: linear-gradient(135deg, var(--ultraviolet), var(--cobalt));
  border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 18px; }
.logo-text { font-size: 1.15rem; font-weight: 300; color: var(--white); }
.logo-text strong { font-weight: 500; color: var(--light-purple); }

/* Pipeline */
.pipeline { display: flex; align-items: center; }
.pipeline-node { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: default; }
.pipeline-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border-card);
  transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
.pipeline-label { font-size: 0.55rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em;
  color: var(--text-muted); white-space: nowrap; }
.pipeline-line { width: 24px; height: 2px; background: var(--border-card); margin: 0 2px; margin-bottom: 18px; transition: background 0.3s; }
.pipeline-node.done .pipeline-dot { border-color: var(--success); background: var(--success); }
.pipeline-node.done .pipeline-dot::after { content: '\2713'; position: absolute; font-size: 9px; color: #fff; font-weight: 700; }
.pipeline-node.done .pipeline-label { color: var(--success); }
.pipeline-line.done { background: var(--success); }
.pipeline-node.active .pipeline-dot { border-color: var(--ultraviolet); background: rgba(99,102,241,0.3);
  box-shadow: 0 0 12px rgba(99,102,241,0.5); animation: pGlow 1.4s ease-in-out infinite; }
.pipeline-node.active .pipeline-label { color: var(--light-purple); }
@keyframes pGlow { 0%,100%{box-shadow:0 0 8px rgba(99,102,241,0.4)} 50%{box-shadow:0 0 20px rgba(99,102,241,0.7)} }

.badge { display: inline-flex; align-items: center; gap: 5px; height: 30px; padding: 0 14px;
  border-radius: var(--radius-pill); font-size: 0.72rem; font-weight: 500;
  letter-spacing: 0.03em; text-transform: uppercase; border: 1px solid var(--border-card); background: var(--bg-card); }
.badge-network { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3); color: var(--light-blue); }

/* Stats bar */
.stats-bar { height: 36px; padding: 0 28px; display: flex; align-items: center; gap: 20px;
  border-bottom: 1px solid var(--border-subtle); background: var(--charcoal);
  font-size: 0.73rem; color: var(--text-secondary); flex-shrink: 0; }
.stats-bar strong { font-family: var(--font-mono); font-weight: 600; color: var(--text-primary); }

/* Error */
.err-banner { padding: 10px 28px; background: rgba(239,68,68,0.08); border-bottom: 1px solid rgba(239,68,68,0.2);
  color: var(--error); font-size: 0.82rem; display: none; align-items: center; gap: 8px; }
.err-banner.show { display: flex; }

/* Main */
.main { display: flex; flex: 1; overflow: hidden; }

/* Left panel */
.panel-left { width: 380px; flex-shrink: 0; border-right: 1px solid var(--border-subtle);
  display: flex; flex-direction: column; overflow-y: auto; padding: 20px; gap: 16px; background: var(--charcoal); }
.panel-left::-webkit-scrollbar { width: 3px; }
.panel-left::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.3); border-radius: 3px; }

/* Trigger controls */
.trigger-controls { display: flex; flex-direction: column; gap: 10px; }
.input-field { width: 100%; padding: 10px 14px; border-radius: var(--radius-md); border: 1px solid var(--border-card);
  background: var(--bg-card); color: var(--text-primary); font-family: var(--font-body); font-size: 0.85rem;
  outline: none; transition: border-color 0.2s; }
.input-field:focus { border-color: var(--ultraviolet); box-shadow: 0 0 0 3px rgba(99,102,241,0.12); }
.input-field::placeholder { color: var(--text-muted); }
textarea.input-field { resize: vertical; min-height: 60px; line-height: 1.5; }
.input-label { font-size: 0.68rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-muted); margin-bottom: -4px; }

.btn-run { width: 100%; height: 44px; border: none; border-radius: var(--radius-pill); background: var(--ultraviolet);
  color: #fff; font-family: var(--font-body); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s;
  display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-run:hover:not(:disabled) { box-shadow: 0 8px 32px rgba(99,102,241,0.35); transform: translateY(-1px); }
.btn-run:disabled { opacity: 0.4; cursor: not-allowed; }
.spinner { display: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
  border-radius: 50%; animation: spin 0.7s linear infinite; }
.btn-run.loading .spinner { display: block; }
.btn-run.loading .btn-label { display: none; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.agent-tag.pulse { animation: pulse 1.5s ease-in-out infinite; }

.section-title { font-size: 0.68rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-muted); display: flex; align-items: center; gap: 10px; margin-top: 4px; }
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border-subtle); }

/* Cards */
.h-card { background: var(--bg-card); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border-card); border-radius: var(--radius-md); padding: 16px; transition: all 0.25s; }
.h-card:hover { background: var(--bg-card-hover); border-color: var(--border-card-hover); box-shadow: var(--shadow-glow); }
.placeholder { border: 1px dashed rgba(99,102,241,0.15); border-radius: var(--radius-md); padding: 18px;
  display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.78rem; }

/* Agent cards */
.agent-row { display: flex; gap: 12px; align-items: flex-start; }
.agent-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center;
  justify-content: center; font-size: 18px; flex-shrink: 0; }
.agent-avatar.escrow { background: rgba(251,191,36,0.12); border: 1px solid rgba(251,191,36,0.35); }
.agent-avatar.analyst { background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.35); }
.agent-avatar.architect { background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.35); }
.agent-avatar.scholar { background: rgba(249,115,22,0.12); border: 1px solid rgba(249,115,22,0.35); }
.agent-info { flex: 1; min-width: 0; }
.agent-name { font-size: 0.88rem; font-weight: 500; display: flex; align-items: center; gap: 8px; }
.agent-tag { font-size: 0.6rem; padding: 1px 7px; border-radius: var(--radius-pill); font-weight: 500;
  letter-spacing: 0.04em; text-transform: uppercase; }
.agent-tag.escrow { background: rgba(251,191,36,0.15); color: var(--gold); }
.agent-tag.analyst { background: rgba(59,130,246,0.15); color: var(--cobalt); }
.agent-tag.architect { background: rgba(16,185,129,0.15); color: var(--green); }
.agent-tag.scholar { background: rgba(249,115,22,0.15); color: #f97316; }
.agent-account { font-family: var(--font-mono); font-size: 0.73rem; color: var(--text-secondary); margin-top: 3px; }
.agent-account a { color: var(--text-secondary); }
.agent-balance { display: flex; align-items: baseline; gap: 5px; margin-top: 10px; padding-top: 10px;
  border-top: 1px solid var(--border-subtle); }
.balance-num { font-family: var(--font-mono); font-size: 1.3rem; font-weight: 600; transition: all 0.3s; }
.balance-num.flash { color: var(--gold); text-shadow: 0 0 16px rgba(255,215,0,0.5); animation: flashBal 0.5s ease; }
@keyframes flashBal { 0%{transform:scale(1.15)} 100%{transform:scale(1)} }
.balance-unit { font-size: 0.75rem; color: var(--text-secondary); }
.escrow-amounts { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; padding-top: 10px;
  border-top: 1px solid var(--border-subtle); }
.escrow-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.78rem; }
.escrow-label { color: var(--text-muted); font-size: 0.72rem; }
.escrow-val { font-family: var(--font-mono); font-weight: 600; font-size: 0.88rem; }
.escrow-val.locked { color: var(--gold); }
.escrow-val.released { color: var(--green); }
.escrow-val.remaining { color: var(--text-secondary); }

/* Steps */
.steps-list { display: flex; flex-direction: column; gap: 4px; }
.step-item { display: flex; align-items: center; gap: 10px; padding: 7px 10px; border-radius: var(--radius-sm);
  font-size: 0.8rem; color: var(--text-muted); transition: all 0.3s; }
.step-item.active { background: rgba(99,102,241,0.1); color: var(--light-purple); }
.step-item.done { color: var(--success); }
.step-num { width: 22px; height: 22px; border-radius: 50%; border: 1.5px solid var(--border-card);
  display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600;
  flex-shrink: 0; transition: all 0.3s; }
.step-item.active .step-num { border-color: var(--ultraviolet); background: rgba(99,102,241,0.2); color: var(--light-purple); }
.step-item.done .step-num { border-color: var(--success); background: rgba(34,197,94,0.15); color: var(--success); }
.step-text { flex: 1; }

/* Right panel */
.panel-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* Token flow */
.token-flow { padding: 14px 24px; border-bottom: 1px solid var(--border-subtle);
  display: flex; align-items: center; justify-content: center; gap: 0;
  flex-shrink: 0; min-height: 80px; background: var(--charcoal); }
.tf-node { display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 8px 12px;
  border: 1px solid var(--border-card); border-radius: var(--radius-sm); background: var(--bg-card);
  min-width: 80px; text-align: center; }
.tf-node-label { font-size: 0.62rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
.tf-node-amount { font-family: var(--font-mono); font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
.tf-node.escrow-tf { border-color: rgba(255,215,0,0.3); }
.tf-node.escrow-tf .tf-node-label { color: var(--gold); }
.tf-arrow { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 0 6px; }
.tf-arrow-line { width: 44px; height: 2px; background: var(--border-card); }
.tf-arrow-label { font-family: var(--font-mono); font-size: 0.58rem; color: var(--text-muted); }
.tf-recipients { display: flex; flex-direction: column; gap: 3px; }
.tf-recipient { font-family: var(--font-mono); font-size: 0.62rem; padding: 2px 8px; border-radius: var(--radius-sm);
  border: 1px solid var(--border-card); background: var(--bg-card); color: var(--text-muted); white-space: nowrap; }
.tf-recipient.paid { border-color: rgba(34,197,94,0.3); color: var(--success); }

/* Feed */
.feed-header { height: 48px; padding: 0 24px; border-bottom: 1px solid var(--border-subtle);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; background: var(--charcoal); }
.feed-title { font-size: 0.82rem; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
.msg-count { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); }
.feed { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
.feed::-webkit-scrollbar { width: 4px; }
.feed::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.25); border-radius: 4px; }

/* Bubbles */
.bubble { max-width: 78%; animation: bubbleIn 0.35s ease-out both; }
@keyframes bubbleIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
.bubble.left { align-self: flex-start; }
.bubble.right { align-self: flex-end; }
.bubble.center { align-self: center; max-width: 85%; }
.bubble-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; gap: 10px; }
.bubble-agent { font-size: 0.75rem; font-weight: 500; display: flex; align-items: center; gap: 5px; }
.bubble-agent.analyst { color: var(--light-blue); }
.bubble-agent.architect { color: var(--green); }
.bubble-agent.scholar { color: var(--warning); }
.bubble-agent.escrow { color: var(--gold); }
.bubble-seq { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); }
.bubble-body { padding: 14px 16px; border-radius: var(--radius-md); border: 1px solid var(--border-card);
  background: var(--bg-card); backdrop-filter: blur(12px); font-size: 0.85rem; line-height: 1.55; }
.bubble.left .bubble-body { border-left: 3px solid var(--cobalt); background: rgba(59,130,246,0.08); }
.bubble.right .bubble-body { border-right: 3px solid var(--green); background: rgba(16,185,129,0.08); }
.bubble.center .bubble-body { border-left: none; border-right: none; border-color: var(--border-subtle);
  background: rgba(255,255,255,0.04); text-align: center; color: var(--text-secondary); font-size: 0.8rem; }
.b-concept { font-size: 0.92rem; font-weight: 500; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.b-desc { color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px; }
.b-field { display: flex; align-items: flex-start; gap: 6px; margin-top: 6px; font-size: 0.82rem; color: var(--text-secondary); }
.b-time { font-size: 0.65rem; color: var(--text-muted); margin-top: 5px; }
.escrow-amount { font-size: 1.4rem; font-weight: 600; color: var(--gold); }
.bid-role-badge { display: inline-flex; padding: 2px 10px; border-radius: var(--radius-pill);
  font-size: 0.68rem; font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
.bid-role-badge.analyst { background: rgba(59,130,246,0.15); color: var(--cobalt); }
.bid-role-badge.architect { background: rgba(16,185,129,0.15); color: var(--green); }
.bid-price { font-family: var(--font-mono); font-size: 1.1rem; font-weight: 600; margin: 6px 0; }
.bid-pitch { font-size: 0.8rem; color: var(--text-secondary); font-style: italic; }
.verdict { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: var(--radius-pill);
  font-size: 0.7rem; font-weight: 600; }
.verdict.pass { background: rgba(34,197,94,0.15); color: var(--success); }
.verdict.fail { background: rgba(239,68,68,0.15); color: var(--error); }
.score-bar { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
.score-track { flex: 1; height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
.score-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
.score-fill.high { background: linear-gradient(90deg, var(--cobalt), var(--light-blue)); }
.score-fill.mid { background: linear-gradient(90deg, var(--warning), #fbbf24); }
.score-fill.low { background: linear-gradient(90deg, var(--error), #fb7185); }
.score-val { font-family: var(--font-mono); font-size: 0.72rem; font-weight: 600; color: var(--text-secondary); }

.log-entry { align-self: center; display: inline-flex; align-items: center; gap: 6px; padding: 5px 14px;
  border-radius: var(--radius-pill); background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle);
  font-size: 0.73rem; color: var(--text-muted); animation: bubbleIn 0.25s ease-out both; }

/* Approval / Review Panels */
.approval-panel { align-self: center; max-width: 500px; width: 100%; padding: 20px; border-radius: var(--radius-md);
  border: 2px solid var(--ultraviolet); background: rgba(99,102,241,0.08); animation: bubbleIn 0.4s ease-out; }
.approval-panel h3 { font-size: 0.95rem; font-weight: 500; color: var(--light-purple); margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px; }
.approval-bid { padding: 10px; border-radius: var(--radius-sm); border: 2px solid var(--border-card);
  background: var(--bg-card); margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
.approval-bid:hover { border-color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.03); }
.approval-bid.bid-selected { border-color: var(--success); background: rgba(34,197,94,0.08); box-shadow: 0 0 12px rgba(34,197,94,0.15); }
.approval-bid-role { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
.approval-bid-price { font-family: var(--font-mono); font-size: 1rem; font-weight: 600; }
.approval-bid-pitch { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }
.btn-approve { padding: 10px 24px; border: none; border-radius: var(--radius-pill); font-family: var(--font-body);
  font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
.btn-approve.accept { background: var(--success); color: #fff; }
.btn-approve.accept:hover { box-shadow: 0 4px 16px rgba(34,197,94,0.35); }

/* Review panel inputs */
.review-group { margin-bottom: 12px; padding: 12px; border-radius: var(--radius-sm);
  border: 1px solid var(--border-card); background: var(--bg-card); }
.review-group-title { font-size: 0.78rem; font-weight: 500; margin-bottom: 8px; }
.review-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.review-label { font-size: 0.72rem; color: var(--text-muted); min-width: 60px; }
.review-input { flex: 1; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-card);
  background: rgba(0,0,0,0.2); color: var(--text-primary); font-family: var(--font-body); font-size: 0.82rem; outline: none; }
.review-input:focus { border-color: var(--ultraviolet); }
.review-checkbox { width: 18px; height: 18px; accent-color: var(--success); }

/* Done card */
.done-card { margin: 8px auto; max-width: 500px; padding: 24px; border-radius: var(--radius-md);
  border: 1px solid rgba(34,197,94,0.25); background: rgba(34,197,94,0.06); text-align: center;
  animation: bubbleIn 0.4s ease-out both; backdrop-filter: blur(12px); }
.done-card h3 { font-size: 1rem; font-weight: 500; color: var(--success); margin-bottom: 8px; }
.done-card p { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 14px; }
.done-links { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.done-link { display: inline-flex; align-items: center; gap: 4px; padding: 6px 14px;
  border-radius: var(--radius-pill); border: 1px solid var(--border-card); background: var(--bg-card);
  font-size: 0.73rem; color: var(--text-secondary); transition: all 0.2s; }
.done-link:hover { border-color: var(--ultraviolet); color: var(--light-purple); text-decoration: none; }

/* Empty state */
.empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 20px; padding: 40px; text-align: center; }
.empty-icon { width: 80px; height: 80px; border-radius: 20px; background: var(--bg-card);
  border: 1px solid var(--border-card); display: flex; align-items: center; justify-content: center;
  font-size: 36px; box-shadow: var(--shadow-glow); }
.empty-title { font-size: 1.2rem; font-weight: 300; color: var(--text-secondary); }
.empty-desc { font-size: 0.85rem; color: var(--text-muted); max-width: 360px; line-height: 1.55; }

footer { height: 42px; padding: 0 28px; border-top: 1px solid var(--border-subtle);
  display: flex; align-items: center; justify-content: center; gap: 20px; flex-shrink: 0;
  background: var(--charcoal); backdrop-filter: blur(12px); }
.foot-item { font-size: 0.68rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
.foot-dot { width: 3px; height: 3px; border-radius: 50%; background: rgba(99,102,241,0.3); }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-left">
      <div class="logo-mark">&#9889;</div>
      <div class="logo-text"><strong>Course Generation</strong> Marketplace</div>
    </div>
    <div id="pipeline" class="pipeline">
      <div class="pipeline-node" data-p="request"><div class="pipeline-dot"></div><div class="pipeline-label">Request</div></div>
      <div class="pipeline-line"></div>
      <div class="pipeline-node" data-p="bidding"><div class="pipeline-dot"></div><div class="pipeline-label">Bidding</div></div>
      <div class="pipeline-line"></div>
      <div class="pipeline-node" data-p="approve"><div class="pipeline-dot"></div><div class="pipeline-label">Approve</div></div>
      <div class="pipeline-line"></div>
      <div class="pipeline-node" data-p="analyst"><div class="pipeline-dot"></div><div class="pipeline-label">Iris</div></div>
      <div class="pipeline-line"></div>
      <div class="pipeline-node" data-p="architect"><div class="pipeline-dot"></div><div class="pipeline-label">Alex</div></div>
      <div class="pipeline-line"></div>
      <div class="pipeline-node" data-p="review"><div class="pipeline-dot"></div><div class="pipeline-label">Your Review</div></div>
      <div class="pipeline-line"></div>
      <div class="pipeline-node" data-p="complete"><div class="pipeline-dot"></div><div class="pipeline-label">Complete</div></div>
    </div>
    <div><span class="badge badge-network">&#11043; Hedera Testnet</span></div>
  </header>

  <div id="errBanner" class="err-banner"><span>&#9888;&#65039;</span><span id="errMsg"></span></div>

  <div id="statsBar" class="stats-bar">
    <span>&#128232; HCS: <strong id="statHcs">0</strong></span>
    <span style="color:var(--border-card)">|</span>
    <span>&#129689; Transferred: <strong id="statKnow">0</strong></span>
    <span style="color:var(--border-card)">|</span>
    <span>&#9201; Elapsed: <strong id="statElapsed">00:00</strong></span>
  </div>

  <div class="main">
    <div class="panel-left">
      <div class="trigger-controls">
        <div class="input-label">Paper URL</div>
        <input id="paperUrl" type="text" class="input-field" placeholder="https://arxiv.org/abs/..." />
        <div class="input-label">Budget (KNOW)</div>
        <input id="budget" type="number" class="input-field" placeholder="100" value="100" min="1" />
        <div class="input-label">Description</div>
        <textarea id="description" class="input-field" placeholder="Describe the course you want..." rows="3"></textarea>
        <button id="btnRun" class="btn-run" onclick="startMarketplace()">
          <span class="btn-label">&#9654; Start Marketplace</span>
          <span class="spinner"></span>
        </button>
      </div>

      <div class="section-title">Agents</div>
      <div id="agentCards" style="display:flex;flex-direction:column;gap:10px;">
        <div id="escrowSlot" class="placeholder">&#128274; Escrow — awaiting setup</div>
        <div id="analystSlot" class="placeholder">&#128300; Analyst — awaiting spawn</div>
        <div id="architectSlot" class="placeholder">&#127959;&#65039; Architect — awaiting spawn</div>
        <div id="scholarSlot" class="placeholder">&#127891; Scholar — awaiting spawn</div>
      </div>

      <div class="section-title">Infrastructure</div>
      <div id="infraCards" style="display:flex;flex-direction:column;gap:10px;">
        <div id="topicSlot" class="placeholder">HCS Topic</div>
        <div id="tokenSlot" class="placeholder">KNOW Token</div>
        <div id="monitorBanner" style="display:none;margin-top:8px;padding:8px 12px;border-radius:var(--radius-sm);background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);text-align:center;"></div>
      </div>

      <div class="section-title">Progress</div>
      <div id="steps" class="steps-list">
        <div class="step-item" data-step="1"><span class="step-num">1</span><span class="step-text">Setup Infrastructure</span></div>
        <div class="step-item" data-step="2"><span class="step-num">2</span><span class="step-text">Course Request &#8594; HCS</span></div>
        <div class="step-item" data-step="3"><span class="step-num">3</span><span class="step-text">Bidding Phase</span></div>
        <div class="step-item" data-step="4"><span class="step-num">4</span><span class="step-text">Iris Analyzing</span></div>
        <div class="step-item" data-step="5"><span class="step-num">5</span><span class="step-text">Alex Designing</span></div>
        <div class="step-item" data-step="6"><span class="step-num">6</span><span class="step-text">Your Review</span></div>
        <div class="step-item" data-step="7"><span class="step-num">7</span><span class="step-text">Course Complete</span></div>
      </div>
    </div>

    <div class="panel-right">
      <div id="tokenFlow" class="token-flow">
        <div class="tf-node escrow-tf"><div class="tf-node-label">Escrow</div><div id="tfEscrow" class="tf-node-amount">0</div></div>
        <div class="tf-arrow"><div class="tf-arrow-line"></div><div class="tf-arrow-label">50 / 50</div></div>
        <div class="tf-recipients">
          <div class="tf-recipient" data-role="analyst">Iris: 50%</div>
          <div class="tf-recipient" data-role="architect">Alex: 50%</div>
        </div>
      </div>

      <div class="feed-header">
        <span class="feed-title">&#128172; HCS Message Feed</span>
        <span id="msgCount" class="msg-count">0 messages</span>
      </div>
      <div id="feed" class="feed">
        <div id="emptyState" class="empty-state">
          <div class="empty-icon">&#127978;</div>
          <div class="empty-title">Waiting for marketplace activity</div>
          <div class="empty-desc">Enter a paper URL and click Start Marketplace. Autonomous agents will bid and work — you approve bids and review results.</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <span class="foot-item">&#11043; Powered by Hedera</span>
    <span class="foot-dot"></span>
    <span class="foot-item">&#129504; Autonomous Agent Economy</span>
    <span class="foot-dot"></span>
    <span class="foot-item" id="monitorLink">&#128065; Agent Monitor</span>
  </footer>
</div>

<script>
var S = { running: false, msgCount: 0, es: null, startTime: null, elapsedTimer: null,
  hcsCount: 0, tokensTransferred: 0, collectedBids: [], bidsByRole: {}, topicId: null, tokenId: null };
var $ = function(s) { return document.querySelector(s); };
var $$ = function(s) { return document.querySelectorAll(s); };

function esc(str) { var d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
function fmtTime(ts) {
  try {
    if (!ts) return '';
    // Hedera Mirror Node: convert "seconds.nanoseconds" string to ms
    var d = (typeof ts === 'string' && /^\d+\.\d+$/.test(ts))
      ? new Date(parseFloat(ts) * 1000)
      : new Date(ts);
    return isNaN(d.getTime()) ? '' : d.toLocaleTimeString();
  } catch(e) { return ''; }
}

/* Pipeline */
var PIPELINE = ['request','bidding','approve','analyst','architect','review','complete'];
var PIPELINE_MAP = { 'idle':-1, 'request':0, 'bidding':1, 'awaiting_bid_approval':2, 'analyst_working':3,
  'architect_working':4, 'awaiting_review':5, 'complete':6 };

function setPipeline(state) {
  var idx = PIPELINE_MAP[state.toLowerCase()] != null ? PIPELINE_MAP[state.toLowerCase()] : -1;
  var nodes = $$('.pipeline-node');
  var lines = $$('.pipeline-line');
  nodes.forEach(function(n,i) { n.classList.remove('done','active');
    if(i<idx) n.classList.add('done'); else if(i===idx) n.classList.add('active'); });
  lines.forEach(function(l,i) { l.classList.remove('done'); if(i<idx) l.classList.add('done'); });
}

/* Agent cards — persona defaults (updated dynamically via SSE agent events) */
var AGENT_META = {
  escrow: {icon:'\uD83D\uDD12',label:'Escrow',name:'Escrow',specialty:'Fund Management',tagline:'',color:'99,102,241'},
  analyst: {icon:'\uD83D\uDD2C',label:'Dr. Iris Chen',name:'Iris',specialty:'Research Analysis',tagline:'The methodology section is where papers live or die.',color:'59,130,246'},
  architect: {icon:'\uD83C\uDFD7\uFE0F',label:'Alex Rivera',name:'Alex',specialty:'Course Design',tagline:'Boring education is a crime.',color:'16,185,129'},
  scholar: {icon:'\uD83C\uDF93',label:'Prof. Nakamura',name:'Nakamura',specialty:'Domain Expertise',tagline:'The answer you need exists at the intersection of fields you haven\'t connected yet.',color:'249,115,22'}
};

function mkAgent(role, accountId, url) {
  var slot = $('#' + role + 'Slot'); if (!slot) return;
  var m = AGENT_META[role] || {};
  slot.className = 'h-card';
  slot.style.cursor = 'pointer';
  slot.onclick = function(){ showAgentLog(role); };
  var taglineHtml = m.tagline ? '<div style="font-size:0.7rem;color:var(--text-muted);font-style:italic;margin-top:4px;">"'+esc(m.tagline)+'"</div>' : '';
  var specialtyHtml = m.specialty ? '<div style="font-size:0.7rem;color:var(--text-secondary);margin-top:2px;">'+esc(m.specialty)+'</div>' : '';
  if (role === 'escrow') {
    slot.innerHTML = '<div class="agent-row"><div class="agent-avatar escrow">'+m.icon+'</div><div class="agent-info">' +
      '<div class="agent-name">'+esc(m.label||m.name)+' <span class="agent-tag escrow">ESCROW</span></div>' +
      specialtyHtml +
      '<div class="agent-account"><a href="'+url+'" target="_blank">'+accountId+'</a></div>' +
      '<div class="escrow-amounts">' +
        '<div class="escrow-row"><span class="escrow-label">\uD83D\uDD12 Locked</span><span id="escrowLocked" class="escrow-val locked">0 KNOW</span></div>' +
        '<div class="escrow-row"><span class="escrow-label">\uD83D\uDD13 Released</span><span id="escrowReleased" class="escrow-val released">0 KNOW</span></div>' +
        '<div class="escrow-row"><span class="escrow-label">\u23F3 Remaining</span><span id="escrowRemaining" class="escrow-val remaining">0 KNOW</span></div>' +
      '</div></div></div>';
  } else if (role === 'scholar') {
    slot.innerHTML = '<div class="agent-row"><div class="agent-avatar scholar">'+m.icon+'</div><div class="agent-info">' +
      '<div class="agent-name">'+esc(m.label||m.name)+' <span class="agent-tag scholar">SCHOLAR</span></div>' +
      specialtyHtml + taglineHtml +
      '<div class="agent-account"><a href="'+url+'" target="_blank">'+accountId+'</a></div>' +
      '<div style="font-size:0.7rem;color:var(--text-muted);margin-top:6px;">Consultation economy — see Agent Monitor</div>' +
      '</div></div>';
  } else {
    slot.innerHTML = '<div class="agent-row"><div class="agent-avatar '+role+'">'+m.icon+'</div><div class="agent-info">' +
      '<div class="agent-name">'+esc(m.label||m.name)+' <span class="agent-tag '+role+'">'+role.toUpperCase()+'</span></div>' +
      specialtyHtml + taglineHtml +
      '<div class="agent-account"><a href="'+url+'" target="_blank">'+accountId+'</a></div>' +
      '<div class="agent-balance"><span id="'+role+'Bal" class="balance-num">0</span><span class="balance-unit">KNOW</span></div>' +
      '</div></div>';
  }
}

function setBalance(role, amt) {
  var el = $('#'+role+'Bal'); if (!el) return;
  el.textContent = amt.toLocaleString();
  el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash');
}

function setEscrow(locked, released, remaining) {
  [['escrowLocked',locked],['escrowReleased',released],['escrowRemaining',remaining]].forEach(function(f) {
    var el = $('#'+f[0]); if (el) el.textContent = f[1] + ' KNOW';
  });
  var tfE = $('#tfEscrow'); if (tfE) tfE.textContent = remaining;
}

function mkInfra(type, id, url, extra) {
  extra = extra || {};
  var slot = type==='topic' ? $('#topicSlot') : $('#tokenSlot'); if (!slot) return;
  var icon = type==='topic' ? '\uD83D\uDCCB' : '\uD83E\uDE99';
  var label = type==='topic' ? 'HCS Topic' : 'KNOW Token';
  if (type==='topic') S.topicId = id;
  if (type==='token') S.tokenId = id;
  slot.className = 'h-card';
  slot.innerHTML = '<div style="display:flex;gap:12px;align-items:center;">' +
    '<div style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(99,102,241,0.1);border:1px solid var(--border-card);">'+icon+'</div>' +
    '<div><div style="font-size:0.68rem;font-weight:500;text-transform:uppercase;color:var(--text-muted);">'+label+'</div>' +
    '<div style="font-family:var(--font-mono);font-size:0.78rem;color:var(--text-secondary);margin-top:2px;"><a href="'+url+'" target="_blank">'+id+'</a></div></div></div>';
  updateMonitorLink();
}

function updateMonitorLink() {
  var el = $('#monitorLink');
  var banner = $('#monitorBanner');
  if (!S.topicId) return;
  var href = '/monitor?topicId=' + S.topicId + (S.tokenId ? '&tokenId=' + S.tokenId : '');
  if (el) el.innerHTML = '<a href="' + href + '" target="_blank" style="color:var(--light-blue);">\uD83D\uDCE1 Agent Monitor \u2192</a>';
  if (banner) { banner.style.display = 'block'; banner.innerHTML = '<a href="' + href + '" target="_blank" style="color:var(--light-blue);font-size:0.75rem;">\uD83D\uDCE1 Open Agent Monitor \u2192</a>'; }
}

function setStep(n, title) {
  $$('.step-item').forEach(function(el) {
    var s = parseInt(el.dataset.step);
    if (s < n) { el.className = 'step-item done'; el.querySelector('.step-num').innerHTML = '\u2713'; }
    else if (s === n) { el.className = 'step-item active'; if(title){var t=el.querySelector('.step-text');if(t)t.textContent=title;} }
    else { el.className = 'step-item'; }
  });
}

/* Feed */
function clearEmpty() { var e=$('#emptyState'); if(e) e.remove(); }
function scrollF() { var f=$('#feed'); var atBottom=f.scrollHeight-f.scrollTop-f.clientHeight<80; if(atBottom) requestAnimationFrame(function(){f.scrollTop=f.scrollHeight;}); }
function toggleDeliv(id) { var el=document.getElementById(id); if(!el) return; if(el.style.maxHeight==='100px'||el.style.maxHeight==='') { el.style.maxHeight='none'; el.style.overflow='auto'; } else { el.style.maxHeight='100px'; el.style.overflow='hidden'; } }
function updCount() { $('#msgCount').textContent = S.msgCount + ' message' + (S.msgCount!==1?'s':''); }

function addToFeed(html) {
  clearEmpty(); var f=$('#feed'); var w=document.createElement('div');
  w.innerHTML=html; f.appendChild(w.firstElementChild); S.msgCount++; updCount(); scrollF();
}

/* Bubble builders */
function bidBubble(d) {
  var role=d.role||'analyst'; var side=role==='analyst'?'left':'right';
  var m=AGENT_META[role]||{}; var personaName=d.senderName||m.name||role;
  return '<div class="bubble '+side+'"><div class="bubble-head">'+
    '<span class="bubble-agent '+role+'">'+(m.icon||'')+' '+esc(personaName)+'</span>'+
    '<span class="bubble-seq">'+(d.seq?'HCS #'+d.seq:'')+'</span></div>'+
    '<div class="bubble-body"><div class="bid-role-badge '+role+'">'+esc(personaName)+' BID</div>'+
    '<div class="bid-price" style="color:var(--'+(role==='analyst'?'light-blue':'green')+');">'+(d.price||0)+' KNOW</div>'+
    (d.pitch?'<div class="bid-pitch">"'+esc(d.pitch)+'"</div>':'')+
    '</div><div class="b-time">'+fmtTime(d.timestamp)+'</div></div>';
}

function onHcsMessage(d) {
  var t = d.type || '';
  S.hcsCount++; updateStats();

  if (t==='course_request') {
    addToFeed('<div class="bubble center"><div class="bubble-body"><div class="b-concept">\uD83D\uDCE8 Course Request</div>'+
      '<div class="b-field">\uD83D\uDCC4 Paper: '+esc(d.payload?.paperUrl||'')+' | Budget: '+(d.payload?.budget||0)+' KNOW</div>'+
      '</div><div class="b-time">'+fmtTime(d.timestamp)+'</div></div>');
  } else if (t==='escrow_lock') {
    addToFeed('<div class="bubble center"><div class="bubble-body">'+
      '<div class="escrow-amount">\uD83D\uDD12 '+(d.payload?.amount||0)+' KNOW</div>'+
      '<div class="b-desc">Locked in escrow</div></div></div>');
  } else if (t==='bid') {
    var bd = d.payload || d;
    addToFeed(bidBubble({seq:d.seq, role:bd.role, price:bd.price, pitch:bd.pitch, senderName:bd.senderName, timestamp:d.timestamp}));
  } else if (t==='bid_accepted') {
    var baRole = d.payload?.role||''; var baM = AGENT_META[baRole]||{}; var baName = d.payload?.senderName||baM.name||baRole;
    addToFeed('<div class="bubble center"><div class="bubble-body">'+
      '<div class="b-concept" style="color:var(--gold);justify-content:center;">\u2713 Accepted: '+esc(baName)+' at '+(d.payload?.price||0)+' KNOW</div>'+
      '</div></div>');
  } else if (t==='deliverable') {
    var role = d.payload?.role || d.senderRole || 'analyst';
    var side = role==='analyst'?'left':'right';
    var dm = AGENT_META[role]||{}; var dName = d.payload?.senderName||dm.name||role;
    var fullContent = d.payload?.content ? JSON.stringify(d.payload.content, null, 2) : (d.payload?.preview||'');
    var did = 'deliv-'+(d.seq||Math.random().toString(36).slice(2));
    addToFeed('<div class="bubble '+side+'"><div class="bubble-head">'+
      '<span class="bubble-agent '+role+'">'+(dm.icon||'')+' '+esc(dName)+'</span>'+
      '<span class="bubble-seq">HCS #'+d.seq+'</span></div>'+
      '<div class="bubble-body"><div class="b-concept">\uD83D\uDCE6 Deliverable <span style="font-size:0.65rem;color:var(--text-muted);cursor:pointer;" onclick="toggleDeliv(\''+did+'\')">[click to expand]</span></div>'+
      '<div id="'+did+'" style="font-family:var(--font-mono);font-size:0.72rem;color:var(--text-secondary);background:rgba(0,0,0,0.2);border-radius:6px;padding:8px;margin-top:6px;max-height:100px;overflow:hidden;cursor:pointer;white-space:pre-wrap;word-break:break-word;" onclick="toggleDeliv(\''+did+'\')">'+
      esc(fullContent)+'</div>'+
      '</div><div class="b-time">'+fmtTime(d.timestamp)+'</div></div>');
  } else if (t==='consultation_fee_quote') {
    var fqP = d.payload||{}; var fqRole = fqP.role||'scholar'; var fqM = AGENT_META[fqRole]||{};
    var fqName = fqP.senderName||fqM.name||fqRole;
    addToFeed('<div class="bubble center"><div class="bubble-body" style="border-left:3px solid var(--warning);background:rgba(249,115,22,0.08);">'+
      '<div class="b-concept" style="justify-content:center;">\uD83C\uDF93 '+esc(fqName)+' quoted '+(fqP.fee||0)+' KNOW'+(fqP.depth?' ('+esc(fqP.depth)+' depth)':'')+'</div>'+
      '</div></div>');
  } else if (t==='fee_accepted') {
    var faP = d.payload||{}; var faRole = faP.role||faP.acceptedBy||'analyst'; var faM = AGENT_META[faRole]||{};
    var faName = faP.senderName||faM.name||faRole;
    addToFeed('<div class="bubble center"><div class="bubble-body" style="border-left:3px solid var(--success);background:rgba(34,197,94,0.06);">'+
      '<div class="b-concept" style="color:var(--success);justify-content:center;">\u2705 '+esc(faName)+' accepted '+(faP.fee||0)+' KNOW fee</div>'+
      '</div></div>');
  } else if (t==='fee_rejected') {
    var frP = d.payload||{}; var frRole = frP.role||frP.rejectedBy||'analyst'; var frM = AGENT_META[frRole]||{};
    var frName = frP.senderName||frM.name||frRole;
    addToFeed('<div class="bubble center"><div class="bubble-body" style="border-left:3px solid var(--error);background:rgba(239,68,68,0.06);">'+
      '<div class="b-concept" style="color:var(--error);justify-content:center;">\u274C '+esc(frName)+' rejected fee'+(frP.reason?': '+esc(frP.reason):'')+'</div>'+
      '</div></div>');
  } else if (t==='revision_request') {
    var rrP = d.payload||{}; var rrRole = rrP.targetRole||rrP.role||'analyst'; var rrM = AGENT_META[rrRole]||{};
    var rrName = rrP.senderName||rrM.name||rrRole; var rrRound = rrP.round||1;
    addToFeed('<div class="bubble center"><div class="bubble-body" style="border-left:3px solid var(--warning);background:rgba(245,158,11,0.1);">'+
      '<div class="b-concept" style="color:var(--warning);justify-content:center;">\uD83D\uDD04 Revision Requested for '+esc(rrName)+' (Round '+rrRound+')</div>'+
      (rrP.feedback?'<div class="b-desc" style="margin-top:6px;text-align:center;">'+esc(rrP.feedback)+'</div>':'')+
      '</div></div>');
    // Move pipeline back to working stage for rework
    if (rrRole==='analyst') setPipeline('analyst_working');
    else if (rrRole==='architect') setPipeline('architect_working');
  } else if (t==='client_review') {
    var p = d.payload||{};
    var approved = p.approved;
    var score = p.score||0;
    var cls = score>=80?'high':score>=50?'mid':'low';
    var crRole = p.targetRole||''; var crM = AGENT_META[crRole]||{}; var crName = p.senderName||crM.name||crRole;
    addToFeed('<div class="bubble center"><div class="bubble-body">'+
      '<div class="b-concept" style="justify-content:center;">\uD83D\uDC64 Your Review: '+esc(crName)+'\'s '+esc(crRole?crRole.charAt(0).toUpperCase()+crRole.slice(1):'')+'</div>'+
      '<div style="margin:6px 0;text-align:center;"><span class="verdict '+(approved?'pass':'fail')+'">'+(approved?'\u2713 APPROVED':'\u2717 REJECTED')+'</span></div>'+
      '<div class="score-bar"><div class="score-track"><div class="score-fill '+cls+'" style="width:'+score+'%"></div></div><span class="score-val">'+score+'%</span></div>'+
      (p.feedback?'<div class="b-desc" style="margin-top:8px;text-align:center;">'+esc(p.feedback)+'</div>':'')+
      '</div></div>');
  } else if (t==='escrow_release') {
    var p=d.payload||{};
    S.tokensTransferred += (p.amount||0); updateStats();
    var erRole = p.role||''; var erM = AGENT_META[erRole]||{}; var erName = p.senderName||erM.name||erRole;
    addToFeed('<div class="bubble center"><div class="bubble-body">'+
      '<div class="escrow-amount">\uD83D\uDD13 '+(p.amount||0)+' KNOW</div>'+
      '<div class="b-desc">\u2192 Released to <strong>'+esc(erName)+'</strong></div>'+
      '</div></div>');
    // Update token flow
    var recip = document.querySelector('.tf-recipient[data-role="'+(p.role||'')+'"]');
    if (recip) { recip.classList.add('paid'); recip.textContent=esc(erName)+': '+(p.amount||0)+' KNOW'; }
  } else if (t==='course_complete') {
    addToFeed('<div class="bubble center"><div class="bubble-body">'+
      '<div class="b-concept" style="color:var(--success);justify-content:center;">\uD83C\uDF93 Course Complete</div>'+
      '</div></div>');
  } else {
    addToFeed('<div class="bubble center"><div class="bubble-body"><b>'+esc(t)+'</b></div></div>');
  }
}

/* Bid approval panel — supports N-bid competitive bidding per role */
function showBidApproval(bids) {
  // Group bids by role for N-bid selection
  var bidsByRole = {};
  bids.forEach(function(bid) {
    if (!bidsByRole[bid.role]) bidsByRole[bid.role] = [];
    bidsByRole[bid.role].push(bid);
  });

  var html = '<div class="approval-panel" id="bidApprovalPanel">';
  html += '<h3>\uD83D\uDC64 Approve Bids</h3>';
  html += '<p style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:12px;">Click a bid card to select it, then approve.</p>';

  Object.keys(bidsByRole).forEach(function(role) {
    var roleBids = bidsByRole[role];
    var m = AGENT_META[role]||{};
    var roleColor = role==='analyst'?'light-blue':'green';
    html += '<div style="margin-bottom:12px;"><div style="font-size:0.72rem;font-weight:600;text-transform:uppercase;color:var(--'+roleColor+');margin-bottom:6px;">'+esc(role)+' bids ('+roleBids.length+')</div>';

    roleBids.forEach(function(bid, idx) {
      var bidM = AGENT_META[bid.role]||{};
      var bidName = bid.senderName || bidM.label || bidM.name || bid.role;
      var bidSpecialty = bid.specialty || bidM.specialty || '';
      var bidTagline = bid.tagline || bidM.tagline || '';
      var radioName = 'bid_'+role;
      var checked = idx===0 ? ' checked' : '';
      var selectedClass = idx===0 ? ' bid-selected' : '';

      html += '<div class="approval-bid'+selectedClass+'" data-role="'+role+'" data-idx="'+idx+'" onclick="selectBid(this,\''+role+'\','+idx+')" style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;transition:all 0.2s;">';
      html += '<input type="radio" name="'+radioName+'" value="'+idx+'" style="margin-top:6px;accent-color:var(--'+roleColor+');pointer-events:none;"'+checked+' />';
      html += '<div style="flex:1;">';
      html += '<div class="approval-bid-role" style="color:var(--'+roleColor+');">'+(bidM.icon||'')+' '+esc(bidName)+'</div>';
      if (bidSpecialty) html += '<div style="font-size:0.68rem;color:var(--text-secondary);">'+esc(bidSpecialty)+'</div>';
      if (bidTagline) html += '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic;margin-top:2px;">"'+esc(bidTagline)+'"</div>';
      html += '<div class="approval-bid-price" style="color:var(--'+roleColor+');">'+bid.price+' KNOW</div>';
      if (bid.pitch) html += '<div class="approval-bid-pitch">"'+esc(bid.pitch)+'"</div>';
      html += '<div style="font-family:var(--font-mono);font-size:0.68rem;color:var(--text-muted);margin-top:4px;">'+esc(bid.sender)+'</div>';
      html += '</div></div>';
    });
    html += '</div>';
  });

  html += '<div style="text-align:center;margin-top:12px;">';
  html += '<button class="btn-approve accept" onclick="approveBids()">&#10003; Approve Selected Bids</button>';
  html += '</div></div>';

  S.collectedBids = bids;
  S.bidsByRole = bidsByRole;
  addToFeed(html);
}

function selectBid(card, role, idx) {
  // Deselect all cards for this role
  document.querySelectorAll('.approval-bid[data-role="'+role+'"]').forEach(function(c) {
    c.classList.remove('bid-selected');
    var r = c.querySelector('input[type="radio"]');
    if (r) r.checked = false;
  });
  // Select clicked card
  card.classList.add('bid-selected');
  var radio = card.querySelector('input[type="radio"]');
  if (radio) radio.checked = true;
}

function approveBids() {
  // Read selected bid per role from radio buttons (always present now)
  var selectedAnalyst, selectedArchitect;

  var analystRadios = document.querySelectorAll('input[name="bid_analyst"]');
  analystRadios.forEach(function(r) { if(r.checked) selectedAnalyst = S.bidsByRole.analyst[parseInt(r.value)]; });

  var architectRadios = document.querySelectorAll('input[name="bid_architect"]');
  architectRadios.forEach(function(r) { if(r.checked) selectedArchitect = S.bidsByRole.architect[parseInt(r.value)]; });

  if (!selectedAnalyst || !selectedArchitect) return;

  fetch('/api/marketplace/bid-approval', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      analystAccountId: selectedAnalyst.sender, analystPrice: selectedAnalyst.price,
      architectAccountId: selectedArchitect.sender, architectPrice: selectedArchitect.price
    })
  });

  var panel = $('#bidApprovalPanel');
  if (panel) { panel.style.opacity='0.5'; panel.style.pointerEvents='none'; }
}

/* Review panel — uses persona names */
function showReviewPanel(data) {
  var aM = AGENT_META.analyst||{}; var archM = AGENT_META.architect||{};
  var aName = aM.name||'Analyst'; var archName = archM.name||'Architect';

  var html = '<div class="approval-panel" id="reviewPanel">';
  html += '<h3>\uD83D\uDC64 Review Deliverables</h3>';
  html += '<p style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:12px;">Score the deliverables and approve to release payment. Scores affect payment: 80+ = full, 50-79 = proportional, &lt;50 = rejected.</p>';

  html += '<div class="review-group"><div class="review-group-title" style="color:var(--light-blue);">'+(aM.icon||'\uD83D\uDD2C')+' Review '+esc(aName)+'\'s Analysis</div>';
  html += '<div class="review-row"><span class="review-label">Approve</span><input type="checkbox" class="review-checkbox" id="rvAnalystApprove" checked /></div>';
  html += '<div class="review-row"><span class="review-label">Score</span><input type="number" class="review-input" id="rvAnalystScore" value="85" min="0" max="100" /></div>';
  html += '<div class="review-row"><span class="review-label">Feedback</span><input type="text" class="review-input" id="rvAnalystFeedback" placeholder="Feedback for '+esc(aName)+'..." /></div>';
  html += '</div>';

  html += '<div class="review-group"><div class="review-group-title" style="color:var(--green);">'+(archM.icon||'\uD83C\uDFD7\uFE0F')+' Review '+esc(archName)+'\'s Design</div>';
  html += '<div class="review-row"><span class="review-label">Approve</span><input type="checkbox" class="review-checkbox" id="rvArchitectApprove" checked /></div>';
  html += '<div class="review-row"><span class="review-label">Score</span><input type="number" class="review-input" id="rvArchitectScore" value="85" min="0" max="100" /></div>';
  html += '<div class="review-row"><span class="review-label">Feedback</span><input type="text" class="review-input" id="rvArchitectFeedback" placeholder="Feedback for '+esc(archName)+'..." /></div>';
  html += '</div>';

  html += '<div style="text-align:center;margin-top:12px;">';
  html += '<button class="btn-approve accept" onclick="submitReview()">&#10003; Submit Review</button>';
  html += '</div></div>';

  addToFeed(html);
}

function submitReview() {
  fetch('/api/marketplace/review', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      analystApproved: $('#rvAnalystApprove').checked,
      analystScore: parseInt($('#rvAnalystScore').value)||0,
      analystFeedback: $('#rvAnalystFeedback').value,
      architectApproved: $('#rvArchitectApprove').checked,
      architectScore: parseInt($('#rvArchitectScore').value)||0,
      architectFeedback: $('#rvArchitectFeedback').value
    })
  });

  var panel = $('#reviewPanel');
  if (panel) { panel.style.opacity='0.5'; panel.style.pointerEvents='none'; }
}

/* Start marketplace */
function startMarketplace() {
  if (S.running) return;
  var paperUrl = $('#paperUrl').value.trim();
  var budget = parseInt($('#budget').value) || 100;
  var description = $('#description').value.trim();
  if (!paperUrl) { $('#paperUrl').focus(); return; }

  S.running = true; S.msgCount = 0; S.hcsCount = 0; S.tokensTransferred = 0; S.collectedBids = []; S.bidsByRole = {};
  updCount(); updateStats();
  $('#errBanner').classList.remove('show');
  $('#feed').innerHTML = '';
  resetPanel(); setPipeline('IDLE'); startTimer();

  var btn = $('#btnRun'); btn.disabled = true; btn.classList.add('loading');

  fetch('/api/marketplace/trigger', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({paperUrl:paperUrl, budget:budget, description:description})
  }).then(function(r) {
    if (!r.ok) throw new Error('Trigger failed: '+r.status);
    return r.json();
  }).then(function() { connectFeed(); }).catch(function(err) { showErr(err.message); cleanup(); });
}

function connectFeed() {
  var es = new EventSource('/api/marketplace/feed'); S.es = es;

  es.addEventListener('marketplace_state', function(e) { setPipeline(JSON.parse(e.data).state); });
  es.addEventListener('step', function(e) { var d=JSON.parse(e.data); setStep(d.step, d.title); });
  es.addEventListener('log', function(e) { var d=JSON.parse(e.data);
    if (d.msg && d.msg.indexOf('[AGENT:')!==-1) {
      var match=d.msg.match(/\[AGENT:(\w+)\]\s*(.*)/);
      if(match){if(!S.agentLogs)S.agentLogs={};if(!S.agentLogs[match[1]])S.agentLogs[match[1]]=[];S.agentLogs[match[1]].push(match[2]);if(S.agentLogs[match[1]].length>200)S.agentLogs[match[1]].shift();}
      return;
    }
    if (d.msg && d.msg.indexOf('[WATCHER]')!==-1) return;
    clearEmpty();
    var el=document.createElement('div'); el.className='log-entry';
    el.innerHTML='<span>'+(d.icon||'\uD83D\uDCCB')+'</span><span>'+esc(d.msg)+'</span>';
    $('#feed').appendChild(el); scrollF(); });
  es.addEventListener('agent', function(e) {
    var d=JSON.parse(e.data);
    // Dynamically update AGENT_META from profile data if present
    if (d.profile && d.role && AGENT_META[d.role]) {
      var m = AGENT_META[d.role];
      if (d.profile.name) m.name = d.profile.name;
      if (d.profile.fullName) m.label = d.profile.fullName;
      if (d.profile.specialty) m.specialty = d.profile.specialty;
      if (d.profile.tagline) m.tagline = d.profile.tagline;
      if (d.profile.icon) m.icon = d.profile.icon;
      if (d.profile.color) m.color = d.profile.color;
    }
    mkAgent(d.role, d.accountId, d.url);
  });
  es.addEventListener('infra', function(e) { var d=JSON.parse(e.data); mkInfra(d.type, d.id, d.url, d); });
  es.addEventListener('hcs_message', function(e) { onHcsMessage(JSON.parse(e.data)); });
  es.addEventListener('escrow_update', function(e) { var d=JSON.parse(e.data); setEscrow(d.locked||0, d.released||0, d.remaining||0); });
  es.addEventListener('balance', function(e) { var d=JSON.parse(e.data);
    if(d.analyst!=null) setBalance('analyst',d.analyst);
    if(d.architect!=null) setBalance('architect',d.architect); });

  es.addEventListener('payment_preview', function(e) {
    var d=JSON.parse(e.data);
    var lines = [];
    ['analyst','architect'].forEach(function(role) {
      var info = d[role];
      if (!info) return;
      var name = info.name || (AGENT_META[role]||{}).name || role;
      var score = info.score||0;
      var bidPrice = info.bidPrice||0;
      var payment = info.payment||0;
      var pctNote = score>=80 ? 'full payment' : score>=50 ? score+'%' : 'rejected';
      lines.push(esc(name)+': '+score+'/100 \u2192 '+payment+' KNOW ('+pctNote+')');
    });
    if (lines.length > 0) {
      addToFeed('<div class="bubble center"><div class="bubble-body" style="border-left:3px solid var(--gold);background:rgba(251,191,36,0.08);">'+
        '<div class="b-concept" style="color:var(--gold);justify-content:center;">\uD83D\uDCB0 Payment Preview</div>'+
        '<div style="text-align:left;margin-top:6px;font-size:0.82rem;color:var(--text-secondary);">'+
        lines.map(function(l){return '<div style="margin:3px 0;">\u2022 '+l+'</div>';}).join('')+
        '</div></div></div>');
    }
  });

  es.addEventListener('agent_status', function(e) {
    var d = JSON.parse(e.data);
    var slot = $('#' + d.role + 'Slot');
    if (!slot) return;
    var tag = slot.querySelector('.agent-tag');
    if (tag) {
      tag.textContent = d.statusText || d.status.toUpperCase();
      tag.className = 'agent-tag ' + d.role + (d.status === 'working' ? ' pulse' : '');
    }
  });
  es.addEventListener('agent_output', function(e) {
    var d=JSON.parse(e.data);
    if (!S.agentLogs) S.agentLogs={};
    if (!S.agentLogs[d.agent]) S.agentLogs[d.agent]=[];
    S.agentLogs[d.agent].push(d.text);
    if (S.agentLogs[d.agent].length>200) S.agentLogs[d.agent].shift();
  });
  es.addEventListener('awaiting_bid_approval', function(e) { var d=JSON.parse(e.data); showBidApproval(d.bids); });
  es.addEventListener('awaiting_review', function(e) { showReviewPanel(JSON.parse(e.data)); });

  es.addEventListener('done', function(e) { finishDemo(JSON.parse(e.data)); });
  es.addEventListener('error', function(e) { try{showErr(JSON.parse(e.data).message);}catch(_){showErr('Connection lost');} cleanup(); });
  es.onerror = function() { if(S.running) cleanup(); };
}

function finishDemo(d) {
  cleanup(); stopTimer(); setPipeline('COMPLETE'); setStep(8);
  var links = '';
  if(d.topic) links += '<a class="done-link" href="'+d.topic.url+'" target="_blank">\uD83D\uDCCB Topic '+d.topic.id+'</a>';
  if(d.token) links += '<a class="done-link" href="'+d.token.url+'" target="_blank">\uD83E\uDE99 Token '+d.token.id+'</a>';
  var aM=AGENT_META.analyst||{}, archMeta=AGENT_META.architect||{}, sM=AGENT_META.scholar||{};
  if(d.analyst) links += '<a class="done-link" href="'+d.analyst.url+'" target="_blank">'+(aM.icon||'\uD83D\uDD2C')+' '+esc(aM.name||'Analyst')+' '+d.analyst.id+'</a>';
  if(d.architect) links += '<a class="done-link" href="'+d.architect.url+'" target="_blank">'+(archMeta.icon||'\uD83C\uDFD7\uFE0F')+' '+esc(archMeta.name||'Architect')+' '+d.architect.id+'</a>';
  if(d.scholar) links += '<a class="done-link" href="'+d.scholar.url+'" target="_blank">'+(sM.icon||'\uD83C\uDF93')+' '+esc(sM.name||'Scholar')+' '+d.scholar.id+'</a>';

  var el = document.createElement('div');
  el.innerHTML = '<div class="done-card"><h3>\u2705 Marketplace Complete</h3><p>Course generated, reviewed by you, and payments released on Hedera Testnet.</p><div class="done-links">'+links+'</div></div>';
  $('#feed').appendChild(el.firstElementChild); scrollF();
}

function showErr(msg) { $('#errMsg').textContent=msg; $('#errBanner').classList.add('show'); }
function cleanup() { S.running=false; if(S.es){S.es.close();S.es=null;} stopTimer();
  var btn=$('#btnRun'); btn.disabled=false; btn.classList.remove('loading'); }

function resetPanel() {
  [['escrowSlot','\uD83D\uDD12 Escrow \u2014 awaiting setup'],['analystSlot','\uD83D\uDD2C Analyst \u2014 awaiting spawn'],
   ['architectSlot','\uD83C\uDFD7\uFE0F Architect \u2014 awaiting spawn'],['scholarSlot','\uD83C\uDF93 Scholar \u2014 awaiting spawn'],
   ['topicSlot','HCS Topic'],['tokenSlot','KNOW Token']].forEach(function(s) {
    var el=document.getElementById(s[0]); if(el){el.className='placeholder';el.innerHTML=s[1];}
  });
  $$('.step-item').forEach(function(el) { el.className='step-item'; el.querySelector('.step-num').textContent=el.dataset.step; });
  $$('.pipeline-node').forEach(function(n){n.classList.remove('done','active');});
  $$('.pipeline-line').forEach(function(l){l.classList.remove('done');});
  $$('.tf-recipient').forEach(function(r) { r.classList.remove('paid');
    var rm = AGENT_META[r.dataset.role]; r.textContent=(rm?rm.name:r.dataset.role)+': 50%'; });
}

function updateStats() {
  var el=$('#statHcs'); if(el) el.textContent=S.hcsCount;
  el=$('#statKnow'); if(el) el.textContent=S.tokensTransferred;
}

function startTimer() { stopTimer(); S.startTime=Date.now();
  S.elapsedTimer=setInterval(function(){
    var sec=Math.floor((Date.now()-S.startTime)/1000);
    var el=$('#statElapsed'); if(el) el.textContent=String(Math.floor(sec/60)).padStart(2,'0')+':'+String(sec%60).padStart(2,'0');
  },1000); }
function stopTimer() { if(S.elapsedTimer){clearInterval(S.elapsedTimer);S.elapsedTimer=null;} }

/* Agent log modal */
function showAgentLog(role) {
  var logs = (S.agentLogs||{})[role]||[];
  var m = AGENT_META[role]||{};
  var d = document.getElementById('agentLogModal');
  d.querySelector('.alm-title').innerHTML = (m.icon||'')+' '+esc(m.label||m.name||role)+' — Agent Log';
  var body = d.querySelector('.alm-body');
  if (logs.length===0) { body.innerHTML='<div style="color:var(--text-muted);padding:20px;text-align:center;">No output yet</div>'; }
  else { body.innerHTML=logs.map(function(l){return '<div class="alm-line">'+esc(l)+'</div>';}).join(''); }
  d.style.display='flex';
  body.scrollTop=body.scrollHeight;
}
function closeAgentLog() { document.getElementById('agentLogModal').style.display='none'; }
</script>

<div id="agentLogModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;" onclick="if(event.target===this)closeAgentLog()">
  <div style="background:var(--charcoal);border:1px solid var(--border-card);border-radius:var(--radius-lg);width:600px;max-width:90vw;max-height:70vh;display:flex;flex-direction:column;overflow:hidden;">
    <div style="padding:14px 18px;border-bottom:1px solid var(--border-card);display:flex;justify-content:space-between;align-items:center;">
      <span class="alm-title" style="font-weight:600;font-size:0.95rem;color:var(--text-primary);"></span>
      <button onclick="closeAgentLog()" style="background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;">&times;</button>
    </div>
    <div class="alm-body" style="padding:12px 18px;overflow-y:auto;flex:1;font-family:var(--font-mono);font-size:0.72rem;line-height:1.6;color:var(--text-secondary);"></div>
  </div>
</div>
<style>.alm-line{padding:2px 0;border-bottom:1px solid var(--border-subtle);white-space:pre-wrap;word-break:break-all;}</style>
</body>
</html>
