<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Activity Explorer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* Background — neutral dark */
  --bg-base: #0f1117;
  --bg-surface: #161922;
  --bg-elevated: #1c2030;
  --border-default: rgba(255, 255, 255, 0.08);
  --border-active: rgba(255, 255, 255, 0.15);

  /* Event type signature colors */
  --color-request: #3b82f6;
  --color-bid: #8b5cf6;
  --color-accepted: #f59e0b;
  --color-work: #10b981;
  --color-review: #ec4899;
  --color-money: #f59e0b;
  --color-consult: #f97316;
  --color-complete: #22c55e;
  --color-error: #ef4444;
  --color-revision: #f59e0b;
  --color-fee: #f97316;
  --color-fee-accept: #22c55e;
  --color-fee-reject: #ef4444;

  /* Text — improved contrast */
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;

  /* Accent */
  --accent: #6366f1;

  /* Agent role colors */
  --agent-analyst: #3b82f6;
  --agent-architect: #10b981;
  --agent-scholar: #f97316;

  --font-body: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
  --radius-sm: 8px; --radius-md: 10px; --radius-pill: 36px;
}

html { font-size: 15px; }
body { font-family: var(--font-body); color: var(--text-primary); min-height: 100vh;
  background: var(--bg-base); }
a { color: var(--accent); text-decoration: none; }
a:hover { color: #818cf8; text-decoration: underline; }

#app { display: flex; flex-direction: column; height: 100vh; }

header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px; height: 56px;
  border-bottom: 1px solid var(--border-default);
  background: var(--bg-surface); backdrop-filter: blur(24px);
  flex-shrink: 0;
}
.header-left { display: flex; align-items: center; gap: 14px; }
.logo-mark { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #3b82f6);
  border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px; }
.logo-text { font-size: 1rem; font-weight: 300; }
.logo-text strong { font-weight: 600; color: #818cf8; }
.header-right { display: flex; align-items: center; gap: 12px; }
.badge { display: inline-flex; align-items: center; gap: 4px; height: 26px; padding: 0 12px;
  border-radius: var(--radius-pill); font-size: 0.68rem; font-weight: 500;
  letter-spacing: 0.03em; text-transform: uppercase; }
.badge-live { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.3); color: var(--color-complete); }
.badge-off { background: rgba(255,255,255,0.04); border: 1px solid var(--border-default); color: var(--text-muted); }

/* Setup */
.setup-bar { padding: 10px 28px; display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid var(--border-default); background: var(--bg-surface); flex-shrink: 0; }
.setup-label { font-size: 0.68rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; }
.setup-input { padding: 6px 10px; border-radius: var(--radius-sm); border: 1px solid var(--border-default);
  background: var(--bg-elevated); color: var(--text-primary); font-family: var(--font-mono); font-size: 0.78rem; outline: none; }
.setup-input:focus { border-color: var(--accent); }
.btn-sm { padding: 6px 16px; border: none; border-radius: var(--radius-pill); color: #fff;
  font-family: var(--font-body); font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
.btn-sm:hover { opacity: 0.85; }
.btn-sm:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-connect { background: var(--accent); }
.back-link { font-size: 0.75rem; color: var(--text-muted); }

/* Main layout */
.main { display: flex; flex: 1; overflow: hidden; }

/* Left: Agents */
.panel-left { width: 280px; flex-shrink: 0; border-right: 1px solid var(--border-default);
  overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px;
  background: var(--bg-surface); }

.section-title { font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--text-muted); display: flex; align-items: center; gap: 8px; padding-top: 4px; }
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border-default); }

/* Agent cards — role-specific border colors */
.a-card { padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-default); background: var(--bg-elevated); }
.a-card.analyst { border-left: 3px solid var(--agent-analyst); }
.a-card.architect { border-left: 3px solid var(--agent-architect); }
.a-card.scholar { border-left: 3px solid var(--agent-scholar); }
.a-row { display: flex; align-items: center; gap: 8px; }
.a-icon { font-size: 20px; }
.a-name { font-size: 0.82rem; font-weight: 600; }
.a-persona { font-size: 0.68rem; color: var(--text-muted); font-style: italic; }
.a-id { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; }
.a-stats { display: flex; gap: 12px; margin-top: 6px; }
.a-stat { font-size: 0.7rem; color: var(--text-secondary); }
.a-stat strong { color: #fbbf24; font-weight: 600; }
.a-actions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.a-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: rgba(99,102,241,0.1); color: var(--text-secondary); }

/* Consultation economy */
.consult-item { padding: 8px 10px; border-radius: var(--radius-sm); border: 1px solid rgba(249,115,22,0.2);
  background: rgba(249,115,22,0.05); font-size: 0.72rem; }
.consult-header { display: flex; justify-content: space-between; align-items: center; }
.consult-fee { color: #fbbf24; font-weight: 600; font-family: var(--font-mono); }
.consult-text { color: var(--text-secondary); margin-top: 4px; }

/* Right: Timeline */
.panel-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.feed-header { height: 42px; padding: 0 20px; border-bottom: 1px solid var(--border-default);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  background: var(--bg-surface); }
.feed-title { font-size: 0.78rem; color: var(--text-secondary); }
.msg-count { font-family: var(--font-mono); font-size: 0.68rem; color: var(--text-muted); }

/* Event count badges */
.evt-counts { display: flex; gap: 6px; align-items: center; }
.evt-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 0.62rem; padding: 2px 6px;
  border-radius: 4px; font-family: var(--font-mono); font-weight: 500; }
.evt-badge.request { background: rgba(59,130,246,0.12); color: var(--color-request); }
.evt-badge.bid { background: rgba(139,92,246,0.12); color: var(--color-bid); }
.evt-badge.work { background: rgba(16,185,129,0.12); color: var(--color-work); }
.evt-badge.money { background: rgba(245,158,11,0.12); color: var(--color-money); }
.evt-badge.review { background: rgba(236,72,153,0.12); color: var(--color-review); }

.feed { flex: 1; overflow-y: auto; padding: 12px 16px; display: flex; flex-direction: column; gap: 6px; }
.feed::-webkit-scrollbar { width: 4px; }
.feed::-webkit-scrollbar-track { background: transparent; }
.feed::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.25); border-radius: 4px; }

/* Timeline events — type-specific background tints */
.evt { display: flex; align-items: flex-start; gap: 10px; padding: 8px 12px;
  border-radius: var(--radius-sm); border-left: 3px solid var(--border-default);
  background: var(--bg-elevated); animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

/* Slide-in animation for new real-time events */
@keyframes slideIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
.evt.new-event { animation: slideIn 0.4s ease-out; }

/* NEW badge */
.new-badge { display: inline-block; font-size: 0.55rem; font-weight: 700; padding: 1px 5px; border-radius: 3px;
  background: var(--color-complete); color: #fff; margin-left: 6px; text-transform: uppercase;
  animation: newPulse 2s ease-out forwards; }
@keyframes newPulse { 0%{opacity:1} 70%{opacity:1} 100%{opacity:0} }

.evt-icon { font-size: 16px; min-width: 24px; text-align: center; padding-top: 1px; }
.evt-body { flex: 1; }
.evt-title { font-size: 0.85rem; font-weight: 500; }
.evt-desc { font-size: 0.78rem; color: var(--text-secondary); margin-top: 2px; }
.evt-meta { font-family: var(--font-mono); font-size: 0.62rem; color: var(--text-muted); margin-top: 3px; }

/* Event type styles — border + background tint */
.evt.request { border-color: var(--color-request); background: rgba(59, 130, 246, 0.08); }
.evt.bid { border-color: var(--color-bid); background: rgba(139, 92, 246, 0.08); }
.evt.accepted { border-color: var(--color-accepted); background: rgba(245, 158, 11, 0.08); }
.evt.work { border-color: var(--color-work); background: rgba(16, 185, 129, 0.08); }
.evt.review { border-color: var(--color-review); background: rgba(236, 72, 153, 0.08); }
.evt.money { border-color: var(--color-money); background: rgba(245, 158, 11, 0.08); }
.evt.consult { border-color: var(--color-consult); background: rgba(249, 115, 22, 0.08); }
.evt.revision { border-color: var(--color-revision); background: rgba(245, 158, 11, 0.1); }
.evt.fee-quote { border-color: var(--color-fee); background: rgba(249, 115, 22, 0.08); }
.evt.fee-accept { border-color: var(--color-fee-accept); background: rgba(34, 197, 94, 0.08); }
.evt.fee-reject { border-color: var(--color-fee-reject); background: rgba(239, 68, 68, 0.08); }
.evt.complete { border-color: var(--color-complete); background: rgba(34, 197, 94, 0.1); }
.evt.raw { border-color: var(--border-default); opacity: 0.5; }

.empty-state { flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 12px;
  text-align: center; color: var(--text-muted); }
.empty-icon { font-size: 40px; opacity: 0.4; }
.empty-text { font-size: 0.85rem; }

/* Loading indicator */
.loading-bar { height: 2px; background: var(--bg-surface); overflow: hidden; flex-shrink: 0; }
.loading-bar.active .loading-fill { animation: loadSlide 1.5s ease-in-out infinite; }
.loading-fill { height: 100%; width: 30%; background: var(--accent); border-radius: 2px; }
@keyframes loadSlide { 0%{transform:translateX(-100%)} 50%{transform:translateX(200%)} 100%{transform:translateX(400%)} }

footer { height: 32px; padding: 0 28px; border-top: 1px solid var(--border-default);
  display: flex; align-items: center; justify-content: center; gap: 16px;
  background: var(--bg-surface); font-size: 0.65rem; color: var(--text-muted); }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-left">
      <div class="logo-mark">&#128225;</div>
      <div class="logo-text"><strong>Agent Explorer</strong> &mdash; Marketplace Activity</div>
    </div>
    <div class="header-right">
      <span id="statusBadge" class="badge badge-off">Disconnected</span>
      <a href="/" class="back-link">&larr; Dashboard</a>
    </div>
  </header>

  <div class="setup-bar">
    <span class="setup-label">Topic</span>
    <input id="topicId" class="setup-input" placeholder="0.0.XXXXX" style="width:140px;" />
    <span class="setup-label">Token</span>
    <input id="tokenId" class="setup-input" placeholder="0.0.YYYYY" style="width:140px;" />
    <button id="btnConnect" class="btn-sm btn-connect" onclick="connect()">Connect</button>
  </div>

  <div class="main">
    <div class="panel-left">
      <div class="section-title">Agents</div>
      <div id="agentList">
        <div style="padding:16px;text-align:center;font-size:0.75rem;color:var(--text-muted);">Connect to see agents</div>
      </div>
      <div class="section-title">Consultation Economy</div>
      <div id="consultList">
        <div style="font-size:0.72rem;color:var(--text-muted);padding:6px;">No consultations yet</div>
      </div>
    </div>

    <div class="panel-right">
      <div class="feed-header">
        <span class="feed-title">Activity Timeline</span>
        <div style="display:flex;align-items:center;gap:12px;">
          <div id="evtCounts" class="evt-counts"></div>
          <span id="msgCount" class="msg-count">0 events</span>
        </div>
      </div>
      <div id="loadingBar" class="loading-bar"><div class="loading-fill"></div></div>
      <div id="feed" class="feed">
        <div class="empty-state">
          <div class="empty-icon">&#128225;</div>
          <div class="empty-text">Enter Topic ID to start exploring agent activity</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <span>On-chain data from Hedera Mirror Node</span>
    <span style="color:var(--border-default);">|</span>
    <span>Polling every 3s</span>
    <span style="color:var(--border-default);">|</span>
    <span>Read-only observer</span>
  </footer>
</div>

<script>
var S = { es: null, count: 0, agents: {}, consultations: [], initialLoading: true,
  typeCounts: {} };
var $ = function(s) { return document.querySelector(s); };
function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

var AGENTS = {
  analyst:   { icon: '\uD83D\uDD2C', name: 'Iris',   persona: 'Dr. Iris Chen', specialty: 'Research Analysis' },
  architect: { icon: '\uD83C\uDFD7\uFE0F', name: 'Alex', persona: 'Alex Rivera', specialty: 'Course Design' },
  scholar:   { icon: '\uD83C\uDF93', name: 'Nakamura',   persona: 'Prof. Nakamura', specialty: 'Domain Expertise' }
};

function connect() {
  var topicId = $('#topicId').value.trim();
  var tokenId = $('#tokenId').value.trim();
  if (!topicId) { $('#topicId').focus(); return; }

  if (S.es) { S.es.close(); }
  S.count = 0; S.agents = {}; S.consultations = []; S.initialLoading = true; S.typeCounts = {};
  $('#feed').innerHTML = '';
  $('#agentList').innerHTML = '';
  $('#consultList').innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);padding:6px;">No consultations yet</div>';
  $('#msgCount').textContent = '0 events';
  $('#evtCounts').innerHTML = '';
  $('#statusBadge').className = 'badge badge-off';
  $('#statusBadge').textContent = 'Connecting...';
  $('#btnConnect').disabled = true;
  $('#loadingBar').classList.add('active');

  var url = '/api/monitor/feed?topicId=' + encodeURIComponent(topicId);
  if (tokenId) url += '&tokenId=' + encodeURIComponent(tokenId);

  var es = new EventSource(url);
  S.es = es;

  es.addEventListener('connected', function() {
    $('#statusBadge').className = 'badge badge-live';
    $('#statusBadge').innerHTML = '&#9679; Live';
    $('#btnConnect').disabled = false;
    $('#btnConnect').textContent = 'Reconnect';
  });

  // Phase 1: Initial load — messages arrive in desc order (newest first), append as-is
  es.addEventListener('hcs_message', function(e) {
    var d = JSON.parse(e.data);
    addEvent(d, false);
    trackAgent(d);
    trackConsultation(d);
  });

  // Phase 1 complete signal
  es.addEventListener('initial_load_complete', function(e) {
    S.initialLoading = false;
    $('#loadingBar').classList.remove('active');
    var d = JSON.parse(e.data);
    if (d.total === 0) {
      $('#feed').innerHTML = '<div class="empty-state"><div class="empty-icon">&#128225;</div>' +
        '<div class="empty-text">No messages found in this topic yet</div></div>';
    }
  });

  // Phase 2: New real-time messages — prepend to top with animation
  es.addEventListener('new_message', function(e) {
    var d = JSON.parse(e.data);
    if (d._raw) {
      addRaw(d, true);
    } else {
      addEvent(d, true);
      trackAgent(d);
      trackConsultation(d);
    }
  });

  es.addEventListener('raw_message', function(e) {
    var d = JSON.parse(e.data);
    addRaw(d, false);
  });

  es.addEventListener('poll_error', function(e) {
    var d = JSON.parse(e.data);
    addEvent({ type: '_error', _msg: d.message }, false);
  });

  es.onerror = function() {
    $('#statusBadge').className = 'badge badge-off';
    $('#statusBadge').textContent = 'Disconnected';
    $('#btnConnect').disabled = false;
    $('#btnConnect').textContent = 'Reconnect';
    $('#loadingBar').classList.remove('active');
  };
}

/* Event type config with icons and color classes */
/* Helper to resolve persona name from role */
function personaName(role, senderName) {
  if (senderName) return senderName;
  var a = AGENTS[role]; return a ? a.name : (role||'unknown');
}

var EVT_CONFIG = {
  course_request: { icon: '\uD83D\uDCE8', cls: 'request', label: 'New Course Request', countKey: 'request',
    detail: function(d) { return 'Paper: <strong>' + esc(d.paperUrl||'') + '</strong> &mdash; Budget: ' + (d.budget||0) + ' KNOW'; } },
  bid: { icon: '\uD83C\uDFF7\uFE0F', cls: 'bid', label: 'Bid Submitted', countKey: 'bid',
    detail: function(d) { return '<strong>' + esc(personaName(d.role, d.senderName)) + '</strong> bids ' + (d.price||0) + ' KNOW &mdash; "' + esc((d.pitch||'').slice(0,100)) + '"'; } },
  bid_accepted: { icon: '\u2705', cls: 'accepted', label: 'Bid Accepted', countKey: 'bid',
    detail: function(d) { return '<strong>' + esc(personaName(d.role, d.senderName)) + '</strong> accepted at ' + (d.price||0) + ' KNOW'; } },
  escrow_lock: { icon: '\uD83D\uDD12', cls: 'money', label: 'Escrow Locked', countKey: 'money',
    detail: function(d) { return (d.amount||0) + ' KNOW locked in escrow'; } },
  escrow_release: { icon: '\uD83D\uDCB0', cls: 'money', label: 'Payment Released', countKey: 'money',
    detail: function(d) { return (d.amount||0) + ' KNOW paid to <strong>' + esc(personaName(d.role, d.senderName)||d.toAccountId||'') + '</strong>'; } },
  deliverable: { icon: '\uD83D\uDCE6', cls: 'work', label: 'Work Delivered', countKey: 'work',
    detail: function(d) {
      var c = d.content || {};
      var title = c.paperTitle || c.courseTitle || '';
      return '<strong>' + esc(personaName(d.role, d.senderName)) + '</strong> submitted' + (title ? ': "' + esc(title) + '"' : '');
    } },
  client_review: { icon: '\u2B50', cls: 'review', label: 'Client Review', countKey: 'review',
    detail: function(d) {
      var status = d.approved ? '<span style="color:var(--color-complete);">Approved</span>' : '<span style="color:var(--color-error);">Rejected</span>';
      return '<strong>' + esc(personaName(d.targetRole, d.senderName)) + '</strong>: ' + status + ' &mdash; ' + (d.score||0) + '/100';
    } },
  consultation_request: { icon: '\uD83D\uDCAC', cls: 'consult', label: 'Consultation Request', countKey: 'request',
    detail: function(d) { return esc(personaName(d.senderRole, d.senderName)||d.sender||'') + ' asks: "' + esc((d.question||'').slice(0,80)) + '" (offers ' + (d.offeredFee||0) + ' KNOW)'; } },
  consultation_response: { icon: '\uD83D\uDCA1', cls: 'consult', label: 'Consultation Answer', countKey: 'work',
    detail: function(d) { return esc(personaName('scholar', d.senderName)) + ' answers for ' + (d.fee||0) + ' KNOW: "' + esc((d.answer||'').slice(0,80)) + '"'; } },
  revision_request: { icon: '\uD83D\uDD04', cls: 'revision', label: 'Revision Request', countKey: 'review',
    detail: function(d) {
      var target = personaName(d.targetRole||d.role, d.senderName);
      var round = d.round || 1;
      return 'Revision requested for <strong>' + esc(target) + '</strong> (Round ' + round + ')' +
        (d.feedback ? ' &mdash; "' + esc(d.feedback.slice(0,100)) + '"' : '');
    } },
  consultation_fee_quote: { icon: '\uD83C\uDF93', cls: 'fee-quote', label: 'Fee Quote', countKey: 'request',
    detail: function(d) {
      var quoter = personaName(d.role||'scholar', d.senderName);
      return '<strong>' + esc(quoter) + '</strong> quoted ' + (d.fee||0) + ' KNOW' +
        (d.depth ? ' (' + esc(d.depth) + ' depth)' : '');
    } },
  fee_accepted: { icon: '\u2705', cls: 'fee-accept', label: 'Fee Accepted', countKey: 'money',
    detail: function(d) {
      var accepter = personaName(d.role||d.acceptedBy, d.senderName);
      return '<strong>' + esc(accepter) + '</strong> accepted ' + (d.fee||0) + ' KNOW fee';
    } },
  fee_rejected: { icon: '\u274C', cls: 'fee-reject', label: 'Fee Rejected', countKey: 'review',
    detail: function(d) {
      var rejecter = personaName(d.role||d.rejectedBy, d.senderName);
      return '<strong>' + esc(rejecter) + '</strong> rejected fee' +
        (d.reason ? ': ' + esc(d.reason) : '');
    } },
  course_complete: { icon: '\uD83C\uDF89', cls: 'complete', label: 'Course Complete', countKey: 'work',
    detail: function(d) { return 'Marketplace session finished successfully'; } }
};

function addEvent(d, isNew) {
  var feed = $('#feed');
  if (S.count === 0) feed.innerHTML = '';

  var cfg = EVT_CONFIG[d.type] || { icon: '\uD83D\uDD38', cls: '', label: d.type || 'unknown', countKey: 'request',
    detail: function(d) { return esc(JSON.stringify(d).slice(0,120)); } };

  // Track type counts
  if (cfg.countKey) {
    S.typeCounts[cfg.countKey] = (S.typeCounts[cfg.countKey] || 0) + 1;
    renderEvtCounts();
  }

  var time = '';
  try {
    var raw = d.timestamp || d.hcsTimestamp;
    if (raw) {
      var dt = (typeof raw === 'string' && /^\d+\.\d+$/.test(raw))
        ? new Date(parseFloat(raw) * 1000) : new Date(raw);
      if (!isNaN(dt.getTime())) time = dt.toLocaleTimeString();
    }
  } catch(_) {}

  var row = document.createElement('div');
  row.className = 'evt ' + cfg.cls + (isNew ? ' new-event' : '');
  row.innerHTML =
    '<div class="evt-icon">' + cfg.icon + '</div>' +
    '<div class="evt-body">' +
      '<div class="evt-title">' + cfg.label + (isNew ? '<span class="new-badge">NEW</span>' : '') + '</div>' +
      '<div class="evt-desc">' + cfg.detail(d) + '</div>' +
      '<div class="evt-meta">#' + (d.seq||'') + (time ? ' &middot; ' + time : '') + '</div>' +
    '</div>';

  if (isNew) {
    // Real-time new messages — prepend to top
    feed.prepend(row);
  } else {
    // Initial load (already in desc/newest-first from server) — append preserves order
    feed.appendChild(row);
  }

  S.count++;
  $('#msgCount').textContent = S.count + ' event' + (S.count!==1?'s':'');
}

function addRaw(d, isNew) {
  var feed = $('#feed');
  if (S.count === 0) feed.innerHTML = '';
  var row = document.createElement('div');
  row.className = 'evt raw' + (isNew ? ' new-event' : '');
  row.innerHTML =
    '<div class="evt-icon">\uD83D\uDCC4</div>' +
    '<div class="evt-body">' +
      '<div class="evt-title">Raw Message' + (isNew ? '<span class="new-badge">NEW</span>' : '') + '</div>' +
      '<div class="evt-desc" style="font-family:var(--font-mono);font-size:0.68rem;">' + esc(d.raw||'') + '</div>' +
      '<div class="evt-meta">#' + (d.seq||'') + '</div>' +
    '</div>';

  if (isNew) {
    feed.prepend(row);
  } else {
    feed.appendChild(row);
  }
  S.count++;
  $('#msgCount').textContent = S.count + ' event' + (S.count!==1?'s':'');
}

/* Event count badges in header */
var COUNT_META = {
  request: { icon: '\uD83D\uDCE8', cls: 'request' },
  bid: { icon: '\uD83C\uDFF7\uFE0F', cls: 'bid' },
  work: { icon: '\uD83D\uDCE6', cls: 'work' },
  money: { icon: '\uD83D\uDCB0', cls: 'money' },
  review: { icon: '\u2B50', cls: 'review' }
};

/* Also add CSS badge styles for new fee-related types */

function renderEvtCounts() {
  var el = $('#evtCounts');
  var html = '';
  Object.keys(COUNT_META).forEach(function(key) {
    var n = S.typeCounts[key] || 0;
    if (n > 0) {
      var m = COUNT_META[key];
      html += '<span class="evt-badge ' + m.cls + '">' + m.icon + ' ' + n + '</span>';
    }
  });
  el.innerHTML = html;
}

/* Agent tracking */
function trackAgent(d) {
  var sender = d.sender || '';
  if (!sender || sender === 'server' || sender === 'requester') return;
  var role = d.role || guessRole(d);
  if (!S.agents[sender]) {
    S.agents[sender] = { accountId: sender, role: role, actions: [], balance: 0 };
  }
  var a = S.agents[sender];
  if (role !== 'unknown') a.role = role;
  a.actions.push(d.type);
  if (d.type === 'escrow_release' && d.toAccountId === sender) a.balance += (d.amount || 0);
  renderAgents();
}

function guessRole(d) {
  if (d.type === 'consultation_response' || d.type === 'consultation_fee_quote') return 'scholar';
  return d.role || 'unknown';
}

function renderAgents() {
  var list = $('#agentList');
  list.innerHTML = '';
  Object.values(S.agents).forEach(function(a) {
    var meta = AGENTS[a.role] || { icon: '\uD83E\uDD16', name: a.role, persona: '', specialty: '' };
    var card = document.createElement('div');
    card.className = 'a-card ' + (a.role || '');

    var uniqueActions = [];
    a.actions.forEach(function(act) { if (uniqueActions.indexOf(act) === -1) uniqueActions.push(act); });

    card.innerHTML =
      '<div class="a-row"><span class="a-icon">' + meta.icon + '</span>' +
        '<div><div class="a-name">' + esc(meta.persona||meta.name) + '</div>' +
        (meta.specialty ? '<div class="a-persona">' + esc(meta.specialty) + '</div>' : '') + '</div></div>' +
      '<div class="a-id">' + esc(a.accountId) + '</div>' +
      '<div class="a-stats">' +
        '<div class="a-stat">Actions: <strong>' + a.actions.length + '</strong></div>' +
        (a.balance > 0 ? '<div class="a-stat">Earned: <strong>' + a.balance + ' KNOW</strong></div>' : '') +
      '</div>' +
      '<div class="a-actions">' + uniqueActions.map(function(t) { return '<span class="a-tag">' + t + '</span>'; }).join('') + '</div>';
    list.appendChild(card);
  });
}

/* Consultation tracking — includes fee negotiations */
function trackConsultation(d) {
  var consultTypes = ['consultation_request','consultation_response','consultation_fee_quote','fee_accepted','fee_rejected'];
  if (consultTypes.indexOf(d.type) === -1) return;
  S.consultations.push(d);
  renderConsultations();
}

function renderConsultations() {
  var list = $('#consultList');
  list.innerHTML = '';
  if (S.consultations.length === 0) {
    list.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);padding:6px;">No consultations yet</div>';
    return;
  }
  S.consultations.slice(-8).forEach(function(c) {
    var div = document.createElement('div');
    div.className = 'consult-item';
    var iconLabel, fee, text;

    if (c.type === 'consultation_request') {
      iconLabel = '\uD83D\uDCAC Question';
      fee = c.offeredFee || 0;
      text = esc((c.question || '').slice(0, 60));
    } else if (c.type === 'consultation_response') {
      iconLabel = '\uD83D\uDCA1 Answer';
      fee = c.fee || 0;
      text = esc((c.answer || '').slice(0, 60));
    } else if (c.type === 'consultation_fee_quote') {
      iconLabel = '\uD83C\uDF93 Fee Quote';
      fee = c.fee || 0;
      text = esc(personaName(c.role||'scholar', c.senderName)) + ' quoted' + (c.depth ? ' (' + esc(c.depth) + ')' : '');
    } else if (c.type === 'fee_accepted') {
      iconLabel = '\u2705 Fee Accepted';
      fee = c.fee || 0;
      text = esc(personaName(c.role||c.acceptedBy, c.senderName)) + ' accepted';
      div.style.borderColor = 'rgba(34,197,94,0.3)';
      div.style.background = 'rgba(34,197,94,0.05)';
    } else if (c.type === 'fee_rejected') {
      iconLabel = '\u274C Fee Rejected';
      fee = c.fee || 0;
      text = esc(personaName(c.role||c.rejectedBy, c.senderName)) + (c.reason ? ': ' + esc(c.reason.slice(0,40)) : '');
      div.style.borderColor = 'rgba(239,68,68,0.3)';
      div.style.background = 'rgba(239,68,68,0.05)';
    } else {
      return;
    }

    div.innerHTML =
      '<div class="consult-header">' +
        '<span>' + iconLabel + '</span>' +
        '<span class="consult-fee">' + fee + ' KNOW</span>' +
      '</div>' +
      '<div class="consult-text">' + text + '</div>';
    list.appendChild(div);
  });
}

/* Auto-connect from URL params */
(function() {
  var p = new URLSearchParams(window.location.search);
  if (p.get('topicId')) $('#topicId').value = p.get('topicId');
  if (p.get('tokenId')) $('#tokenId').value = p.get('tokenId');
  if (p.get('topicId')) connect();
})();
</script>
</body>
</html>
